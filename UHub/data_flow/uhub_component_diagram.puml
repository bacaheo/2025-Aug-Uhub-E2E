@startuml UHub_System_Architecture
!theme aws-orange
title UHub System Architecture - Component Diagram\nData Flows & System Interfaces

skinparam component {
  BackgroundColor White
  BorderColor Black
  ArrowColor DarkBlue
}

skinparam interface {
  BackgroundColor LightBlue
  BorderColor Blue
}

' === EXTERNAL ACTORS ===
actor "Shopper" as shopper
actor "PG (Promoter)" as pg
actor "BU Team" as bu
actor "Utop Admin" as admin
actor "Sales" as sales
actor "Agency" as agency

' === EXTERNAL SYSTEMS ===
component "UGMS\n(Unilever Gift\nManagement)" as ugms {
  interface "Gift Setup API" as ugms_api
  interface "Sync API" as ugms_sync
}

component "Gift Vendors" as vendors {
  component "GotIt API" as gotit
  component "Urbox API" as urbox
  interface "E-Gift API" as egift_api
}

component "Azure OCR" as azure {
  interface "OCR Processing" as ocr_api
}

component "ITU Log Form" as itu_form {
  interface "Campaign Request" as itu_api
}

component "PowerBI" as powerbi {
  interface "Analytics API" as powerbi_api
}

component "Notification Services" as notif {
  component "SMS Gateway" as sms
  component "Zalo ZNS" as zalo
  interface "Message API" as msg_api
}

' === UHUB CORE SYSTEM ===
package "UHub Core Platform" {

  ' Frontend Layer
  component "Shopper WebApp" as shopper_app {
    interface "Receipt Upload" as receipt_ui
    interface "Gift Redemption" as gift_ui
    interface "Profile Management" as profile_ui
  }

  component "PG Mobile App" as pg_app {
    interface "QR Scanner" as qr_scanner
    interface "Gift Distribution" as gift_dist
    interface "Sampling Management" as sampling_ui
  }

  component "Admin Portal" as admin_portal {
    interface "Campaign Setup" as campaign_ui
    interface "Inventory Management" as inventory_ui
    interface "User Management" as user_mgmt_ui
  }

  ' API Gateway Layer
  component "UHub API Gateway" as api_gateway {
    interface "Authentication API" as auth_api
    interface "Campaign API" as campaign_api
    interface "Receipt API" as receipt_api
    interface "Gift API" as gift_api
    interface "User API" as user_api
  }

  ' Core Business Logic Layer
  component "Authentication Service" as auth_service {
    database "User Database" as user_db
  }

  component "Campaign Management" as campaign_mgmt {
    database "Campaign Database" as campaign_db
    interface "Campaign Logic" as campaign_logic
  }

  component "Receipt Processing" as receipt_processing {
    component "OCR Engine" as ocr_engine
    component "Receipt Validator" as receipt_validator
    component "KA Recognition" as ka_recognition
    database "Receipt Database" as receipt_db
  }

  component "Anti-Fraud Engine" as fraud_engine {
    component "Abnormal Detection" as abnormal_detect
    component "Duplicate Checker" as duplicate_check
    component "Blacklist Manager" as blacklist_mgmt
    database "Fraud Database" as fraud_db
  }

  component "Gift Management" as gift_mgmt {
    component "Gift Allocation" as gift_allocation
    component "Inventory Tracker" as inventory_tracker
    component "Redemption Handler" as redemption_handler
    database "Gift Database" as gift_db
  }

  component "Workflow Engine" as workflow_engine {
    component "State Machine" as state_machine
    component "Approval Workflow" as approval_workflow
    component "Notification Trigger" as notif_trigger
  }

  component "Integration Service" as integration_service {
    component "UGMS Connector" as ugms_connector
    component "Vendor Connector" as vendor_connector
    component "PowerBI Connector" as powerbi_connector
  }

  ' Hotline Support System
  component "Hotline Support" as hotline {
    interface "Manual Review" as manual_review
    interface "Approval Interface" as approval_interface
    database "Support Database" as support_db
  }
}

' === DATA FLOWS & CONNECTIONS ===

' Shopper Journey Data Flow
shopper --> receipt_ui : "1. Upload Receipt Image"
receipt_ui --> receipt_api : "Receipt Data"
receipt_api --> receipt_processing : "Process Receipt"
receipt_processing --> ocr_api : "OCR Request"
azure --> ocr_engine : "OCR Response"
receipt_processing --> ka_recognition : "Identify Store"
receipt_processing --> receipt_validator : "Validate Receipt"
receipt_validator --> fraud_engine : "Fraud Check"
fraud_engine --> workflow_engine : "Status Update"
workflow_engine --> campaign_mgmt : "Check Eligibility"
campaign_mgmt --> gift_mgmt : "Calculate Rewards"
gift_mgmt --> workflow_engine : "Gift Allocation"
workflow_engine --> notif_trigger : "Send Notification"
notif_trigger --> msg_api : "SMS/Zalo"
notif_api --> shopper : "2. Gift Notification"

' PG Journey Data Flow
pg --> qr_scanner : "3. Scan QR Code"
qr_scanner --> gift_api : "QR Validation"
gift_api --> gift_mgmt : "Verify Gift"
gift_mgmt --> redemption_handler : "Process Redemption"
redemption_handler --> workflow_engine : "Update Status"
workflow_engine --> gift_db : "Update Inventory"

' Campaign Setup Data Flow
bu --> itu_api : "4. Campaign Request"
itu_form --> admin_portal : "Auto Email"
admin --> campaign_ui : "5. Setup Campaign"
campaign_ui --> campaign_api : "Campaign Data"
campaign_api --> campaign_mgmt : "Create Campaign"

' UGMS Integration Data Flow
ugms_api --> ugms_connector : "6. Gift Setup Sync"
ugms_connector --> gift_mgmt : "Update Gift Data"
gift_mgmt --> ugms_sync : "7. Usage Sync"
ugms_sync --> ugms : "Update UGMS"

' Gift Vendor Integration
gift_mgmt --> vendor_connector : "8. E-Gift Request"
vendor_connector --> egift_api : "API Call"
vendors --> vendor_connector : "E-Gift Response"

' Analytics & Reporting
campaign_mgmt --> powerbi_connector : "9. Performance Data"
gift_mgmt --> powerbi_connector : "Gift Usage Data"
powerbi_connector --> powerbi_api : "Analytics Data"
powerbi --> bu : "10. PowerBI Reports"

' Hotline Support Flow
workflow_engine --> manual_review : "Pending Cases"
admin --> approval_interface : "Manual Approval"
approval_interface --> workflow_engine : "Approval Decision"

' Inventory Management
agency --> inventory_ui : "11. Stock Updates"
sales --> inventory_ui : "Store Allocation"
inventory_ui --> gift_mgmt : "Inventory Data"

' === DETAILED INTERFACES ===
note right of receipt_processing
  **Receipt Processing Flow:**
  1. OCR text extraction
  2. Store recognition (KA mapping)
  3. Product extraction
  4. Amount validation
  5. Date/time validation
  6. Duplicate detection
  7. Campaign eligibility check
end note

note right of fraud_engine
  **Anti-Fraud Rules:**
  - Duplicate receipt detection
  - Device fingerprinting
  - User behavior analysis
  - Amount threshold checks
  - Time pattern analysis
  - Blacklist validation
end note

note right of gift_mgmt
  **Gift Management:**
  - Stock allocation by store
  - Real-time inventory tracking
  - Multi-tier approval workflow
  - E-Gift vendor integration
  - Physical gift QR generation
end note

note left of workflow_engine
  **State Machine:**
  Processing → Invalid/Pending/Valid
  → Check → ApprovedByShopper/
  ApprovedByPG/RejectByPG
end note

@enduml