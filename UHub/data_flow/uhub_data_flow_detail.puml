@startuml UHub_Detailed_Data_Flow
!theme aws-orange
title UHub Detailed Data Flow Analysis\nSequence & State Transitions

' === MAIN DATA FLOW PROCESSES ===

package "B1. Gift Planning Process" {
  [UGMS] --> [ITU Log Form] : Gift Setup Data
  [ITU Log Form] --> [UHub Admin] : Campaign Request
  [UHub Admin] --> [Campaign Management] : Setup Campaign
  [Campaign Management] --> [Gift Database] : Store Campaign Config
}

package "B2-B3. Inventory Management" {
  [Agency System] --> [UHub Inventory] : Stock Confirmation
  [UHub Inventory] --> [Allocation Engine] : Store Allocation
  [Allocation Engine] --> [Gift Database] : Update Inventory
  [Sales System] --> [UHub Inventory] : Store Stock Update
}

package "Receipt Processing Flow" {
  [Shopper WebApp] --> [API Gateway] : Receipt Image
  [API Gateway] --> [OCR Engine] : Image Processing Request
  [OCR Engine] --> [Azure OCR] : External OCR Call
  [Azure OCR] --> [Receipt Validator] : OCR Response
  [Receipt Validator] --> [KA Recognition] : Store Identification
  [KA Recognition] --> [Product Extractor] : Extract Products
  [Product Extractor] --> [Campaign Matcher] : Match Campaign Rules
  [Campaign Matcher] --> [Fraud Engine] : Fraud Check
  [Fraud Engine] --> [State Machine] : Status Decision
}

package "Gift Redemption Flow" {
  [State Machine] --> [Gift Calculator] : Valid Receipt
  [Gift Calculator] --> [Inventory Tracker] : Check Availability
  [Inventory Tracker] --> [Gift Allocator] : Allocate Gift
  [Gift Allocator] --> [Notification Service] : Send SMS/Zalo
  [Gift Allocator] --> [QR Generator] : Generate QR for Physical
  [QR Generator] --> [Shopper WebApp] : Display QR
}

package "PG Operations Flow" {
  [PG App] --> [QR Scanner] : Scan Gift QR
  [QR Scanner] --> [Gift Validator] : Validate QR
  [Gift Validator] --> [Redemption Handler] : Process Redemption
  [Redemption Handler] --> [Inventory Tracker] : Update Stock
  [Inventory Tracker] --> [UGMS Sync] : Sync Usage Data
}

package "Anti-Fraud System" {
  [Duplicate Detector] --> [Pattern Analyzer] : Check Patterns
  [Pattern Analyzer] --> [Risk Scorer] : Calculate Risk
  [Risk Scorer] --> [Blacklist Checker] : Validate User
  [Blacklist Checker] --> [Decision Engine] : Fraud Decision
  [Decision Engine] --> [Manual Review Queue] : Pending Cases
}

package "Hotline Support" {
  [Manual Review Queue] --> [Hotline Interface] : Pending Reviews
  [Hotline Interface] --> [Approval Engine] : Manual Decision
  [Approval Engine] --> [State Machine] : Update Status
  [State Machine] --> [Notification Service] : Notify Shopper
}

package "External Integrations" {
  [Gift Allocator] --> [Vendor Connector] : E-Gift Request
  [Vendor Connector] --> [GotIt API] : API Call
  [Vendor Connector] --> [Urbox API] : API Call
  [GotIt API] --> [SMS Gateway] : Send E-Gift
  [Urbox API] --> [SMS Gateway] : Send E-Gift
}

package "Analytics & Reporting" {
  [Campaign Management] --> [PowerBI Connector] : Campaign Data
  [Gift Database] --> [PowerBI Connector] : Usage Data
  [Receipt Database] --> [PowerBI Connector] : Receipt Data
  [PowerBI Connector] --> [PowerBI] : Analytics Feed
  [PowerBI] --> [BU Dashboard] : Real-time Reports
}

' === DATA FLOW ANNOTATIONS ===

note right of [OCR Engine]
  **OCR Processing:**
  - Image quality validation
  - Text extraction with coordinates
  - Store logo recognition
  - Date/amount parsing
  - Product line identification
end note

note right of [Fraud Engine]
  **Abnormal Detection Rules:**
  - Receipt duplicate check
  - Device fingerprinting limit
  - Amount threshold validation
  - Time pattern analysis
  - User behavior scoring
  - Blacklist validation
end note

note right of [State Machine]
  **Receipt Status Flow:**
  Processing → Invalid
  Processing → Pending
  Processing → Valid
  Valid → Check
  Valid → ApprovedByShopper
  Pending → ApprovedByPG
  Pending → RejectByPG
  Check → ApprovedByPG
  Check → RejectByPG
end note

note left of [Gift Allocator]
  **Gift Types:**
  - E-Gift (SMS/Zalo delivery)
  - Physical Gift (QR redemption)
  - Sampling (PG distribution)
  - Lucky Draw entries
  - Loyalty points
end note

note left of [Inventory Tracker]
  **Multi-level Tracking:**
  - Agency warehouse level
  - Store allocation level
  - Real-time consumption
  - Recall management
  - Cross-store transfers
end note

@enduml